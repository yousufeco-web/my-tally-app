<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abdullah's Tracker</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #2d89ef; --success: #4caf50; --danger: #f44336; --bg: #f8f9fa; --gold: #f39c12; }
        body { font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; background-color: var(--bg); margin: 0; padding: 20px; }
        h1 { color: #333; font-size: 1.5rem; margin-bottom: 5px; }
        .update-text { font-weight: bold; font-size: 1.1rem; margin-bottom: 20px; animation: colorChange 4s infinite; }
        @keyframes colorChange { 0% { color: #2d89ef; } 25% { color: #e91e63; } 50% { color: #4caf50; } 75% { color: #f39c12; } 100% { color: #2d89ef; } }
        .card { background: white; padding: 1.5rem; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 400px; text-align: center; }
        .goal-settings { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; font-size: 0.9rem; }
        .input-row { display: flex; align-items: center; justify-content: center; gap: 10px; }
        .goal-settings input { padding: 5px; border: 1px solid #ddd; border-radius: 5px; text-align: center; }
        .score-display { font-size: 4.5rem; font-weight: 800; color: var(--primary); margin: 5px 0; }
        .goal-reached-text { color: var(--gold); }
        #tally-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; min-height: 80px; padding: 15px; border-radius: 12px; margin-bottom: 20px; background: #fafafa; border: 1px inset #eee; }
        .tally-group { font-size: 2.2rem; letter-spacing: 2px; color: #444; font-weight: bold; }
        .controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; }
        button { border: none; border-radius: 12px; font-size: 1.1rem; cursor: pointer; font-weight: bold; padding: 18px 5px; }
        .btn-add { background-color: var(--success); color: white; }
        .btn-sub { background-color: var(--danger); color: white; }
        .btn-reset-points { background-color: #333; color: white; width: 100%; margin-top: 10px; padding: 12px; font-size: 0.9rem; }
        .history-section { width: 100%; max-width: 400px; margin-top: 20px; }
        .log-item { background: #fff; padding: 12px; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.03); border-left: 4px solid #ccc; }
        .settings-btn { background: none; color: var(--primary); font-size: 0.8rem; margin-bottom: 10px; cursor: pointer; border:none; }
    </style>
</head>
<body>

    <h1>Abdullah's daily points tracker</h1>
    <div class="update-text">Update 5 (Final Fix)</div>
    <button class="settings-btn" onclick="securePasscodeSetup()">Set/Update Passcode</button>

    <div class="card">
        <div class="goal-settings">
            <div class="input-row">Goal: <input type="number" id="goal-input" value="10" onchange="updateGoal(this.value)"></div>
            <div>Reward: <input type="text" id="reward-input" placeholder="Enter reward..." style="width:90%" onchange="updateReward(this.value)"></div>
        </div>
        <div class="score-display" id="score">0</div>
        <div id="tally-container"></div>
        <div class="controls-grid">
            <button class="btn-sub" onclick="updatePoints(-0.5)">‚àí 0.5</button>
            <button class="btn-add" onclick="updatePoints(0.5)">+ 0.5</button>
            <button class="btn-sub" onclick="updatePoints(-1)">‚àí 1.0</button>
            <button class="btn-add" onclick="updatePoints(1)">+ 1.0</button>
        </div>
        <button class="btn-reset-points" onclick="requestResetPoints()">Reset to 0</button>
    </div>

    <div class="history-section">
        <h3 style="color: #444;">Activity Log</h3>
        <div id="log-list"></div>
    </div>

    <script>
        const S_KEY = "806705";
        const firebaseConfig = {
            apiKey: "AIzaSyBLIy6zHXgS2tz0rmeFA6b3dW8q8J1sqJ8",
            authDomain: "daily-points-67f58.firebaseapp.com",
            projectId: "daily-points-67f58",
            storageBucket: "daily-points-67f58.firebasestorage.app",
            messagingSenderId: "7145583134",
            appId: "1:7145583134:web:1bf7bba719819db36e740f",
            databaseURL: "https://daily-points-67f58-default-rtdb.firebaseio.com/"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentPoints = 0, currentGoal = 10, currentReward = "", savedPasscode = null;

        // Listen for all changes
        db.ref('/').on('value', (snap) => {
            const data = snap.val() || {};
            currentPoints = parseFloat(data.live_points || 0);
            currentGoal = parseInt(data.goal_val || 10);
            currentReward = data.reward_text || "";
            savedPasscode = data.pass_code || null;
            
            document.getElementById('score').innerText = Number(currentPoints.toFixed(1));
            document.getElementById('goal-input').value = currentGoal;
            document.getElementById('reward-input').value = currentReward;
            
            renderTallies(currentPoints);
            renderLog(data.activity_log || {});
        });

        function updatePoints(val) {
            const newPoints = Math.max(0, currentPoints + val);
            const now = Date.now();
            db.ref('live_points').set(newPoints);
            db.ref('secret').set(S_KEY); // Keep connection alive
            
            const logMsg = (val > 0 ? "+" : "") + val + " Points";
            db.ref('activity_log').push({ msg: logMsg, time: new Date().toLocaleTimeString(), timestamp: now, secret: S_KEY });

            if (val > 0 && newPoints >= currentGoal && currentPoints < currentGoal) {
                db.ref('activity_log').push({ msg: "Goal Reached! üåü " + currentReward, time: new Date().toLocaleTimeString(), timestamp: now + 1, secret: S_KEY });
            }
        }

        function updateGoal(v) { db.ref('goal_val').set(parseInt(v)); db.ref('secret').set(S_KEY); }
        function updateReward(v) { db.ref('reward_text').set(v); db.ref('secret').set(S_KEY); }

        function renderTallies(p) {
            const container = document.getElementById('tally-container');
            container.innerHTML = '';
            let whole = Math.floor(p);
            for (let i = 0; i < Math.floor(whole/5); i++) container.innerHTML += '<span class="tally-group">Âçå</span>';
            if (whole % 5 > 0) container.innerHTML += `<span class="tally-group">${'|'.repeat(whole % 5)}</span>`;
        }

        function renderLog(data) {
            const list = document.getElementById('log-list');
            list.innerHTML = '';
            Object.values(data).reverse().slice(0, 20).forEach(item => {
                list.innerHTML += `<div class="log-item"><span>${item.time}</span><b>${item.msg}</b></div>`;
            });
        }

        function securePasscodeSetup() {
            let pass = prompt("Set 4-digit passcode:");
            if (pass && pass.length === 4) {
                db.ref('pass_code').set(pass);
                db.ref('secret').set(S_KEY);
                alert("Passcode Set!");
            }
        }

        function requestResetPoints() {
            if (prompt("Enter passcode:") === savedPasscode) {
                db.ref('live_points').set(0);
                db.ref('activity_log').push({ msg: "Reset üîÑ", time: new Date().toLocaleTimeString(), secret: S_KEY });
            } else alert("Wrong!");
        }
    </script>
</body>
</html>
