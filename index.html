<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abdullah's Tracker</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #2d89ef; --success: #4caf50; --danger: #f44336; --bg: #f8f9fa; --gold: #f39c12; }
        body { font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; background-color: var(--bg); margin: 0; padding: 20px; }
        h1 { color: #333; font-size: 1.5rem; margin-bottom: 20px; text-align: center; }
        .card { background: white; padding: 1.5rem; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 400px; text-align: center; margin-bottom: 20px; }
        
        .goal-settings { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; font-size: 0.9rem; color: #666; }
        .input-row { display: flex; align-items: center; justify-content: center; gap: 10px; }
        .goal-settings input[type="number"] { width: 60px; padding: 5px; border: 1px solid #ddd; border-radius: 5px; text-align: center; font-weight: bold; }
        .reward-input { width: 90%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.85rem; }

        .score-display { font-size: 4.5rem; font-weight: 800; color: var(--primary); margin: 5px 0; transition: 0.3s; }
        .goal-reached-text { color: var(--gold); }
        
        #tally-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; min-height: 80px; padding: 15px; border-radius: 12px; margin-bottom: 20px; background: #fafafa; border: 1px inset #eee; }
        .tally-group { font-size: 2.2rem; letter-spacing: 2px; color: #444; font-weight: bold; }
        
        .controls { display: flex; gap: 12px; width: 100%; }
        button { padding: 18px; border: none; border-radius: 12px; font-size: 1.1rem; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-add { background-color: var(--success); color: white; flex: 2; }
        .btn-sub { background-color: var(--danger); color: white; flex: 1; }
        
        .history-section { width: 100%; max-width: 400px; }
        .log-item { background: #fff; padding: 12px; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.03); border-left: 4px solid #ccc; }
        .log-goal { border-left: 4px solid var(--gold); background: #fffdf0; }
        .log-time { font-size: 0.8rem; color: #888; }
        .log-action { font-weight: bold; font-size: 0.9rem; }
        .text-add { color: var(--success); }
        .text-sub { color: var(--danger); }
        .text-goal { color: var(--gold); }
        
        .settings-btn { background: none; color: var(--primary); font-size: 0.8rem; margin-bottom: 10px; cursor: pointer; border:none; opacity: 0.7; }
        .btn-clear { background: #eee; border: none; color: #888; font-size: 0.8rem; padding: 10px; border-radius: 8px; margin-top: 10px; cursor: pointer; width: 100%; }
    </style>
</head>
<body>

    <h1>Abdullah's daily points tracker</h1>
    <button class="settings-btn" onclick="securePasscodeSetup()">Set/Update Security Passcode</button>

    <div class="card">
        <div class="goal-settings">
            <div class="input-row">
                Goal: <input type="number" id="goal-input" min="1" max="1000" onchange="updateGoal(this.value)"> points
            </div>
            <div>
                Reward: <input type="text" id="reward-input" class="reward-input" placeholder="Enter reward for your goal..." onchange="updateReward(this.value)">
            </div>
        </div>
        
        <div class="score-display" id="score">0</div>
        <div id="tally-container"></div>
        <div class="controls">
            <button class="btn-sub" onclick="logActivity(-1)">‚àí</button>
            <button class="btn-add" onclick="logActivity(1)">+ Add Point</button>
        </div>
    </div>

    <div class="history-section">
        <h3 style="color: #444; margin-bottom:10px;">Activity (Last 24 Hours)</h3>
        <div id="log-list"></div>
        <button class="btn-clear" onclick="requestClearLog()">Clear Log History</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBLIy6zHXgS2tz0rmeFA6b3dW8q8J1sqJ8",
            authDomain: "daily-points-67f58.firebaseapp.com",
            projectId: "daily-points-67f58",
            storageBucket: "daily-points-67f58.firebasestorage.app",
            messagingSenderId: "7145583134",
            appId: "1:7145583134:web:1bf7bba719819db36e740f",
            databaseURL: "https://daily-points-67f58-default-rtdb.firebaseio.com/"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentPoints = 0;
        let currentGoal = 10;
        let currentReward = "";
        let savedPasscode = null;

        db.ref('live/points').on('value', (snap) => {
            currentPoints = snap.val() || 0;
            render();
        });

        db.ref('settings/goal').on('value', (snap) => {
            currentGoal = snap.val() || 10;
            document.getElementById('goal-input').value = currentGoal;
            render();
        });

        db.ref('settings/reward').on('value', (snap) => {
            currentReward = snap.val() || "";
            document.getElementById('reward-input').value = currentReward;
        });

        db.ref('activity_log').on('value', (snap) => {
            renderLog(snap.val() || {});
        });

        db.ref('settings/passcode').on('value', (snap) => {
            savedPasscode = snap.val();
        });

        function updateGoal(val) {
            let num = parseInt(val) || 10;
            db.ref('settings/goal').set(Math.min(1000, Math.max(1, num)));
        }

        function updateReward(val) {
            db.ref('settings/reward').set(val);
        }

        function logActivity(val) {
            const newPoints = Math.max(0, currentPoints + val);
            const now = Date.now();
            const timeLabel = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            db.ref('live/points').set(newPoints);
            db.ref('activity_log').push({
                timestamp: now,
                change: val > 0 ? "+1 Point" : "-1 Point",
                type: val > 0 ? "add" : "sub",
                timeLabel: timeLabel
            });
            if (val > 0 && newPoints === currentGoal) {
                let msg = "Goal Achieved! üåü";
                if (currentReward) msg += " Reward: " + currentReward;
                db.ref('activity_log').push({
                    timestamp: now + 1,
                    change: msg,
                    type: "goal",
                    timeLabel: timeLabel
                });
            }
        }

        function render() {
            const isReached = currentPoints >= currentGoal;
            document.getElementById('score').innerText = currentPoints;
            document.getElementById('score').className = isReached ? 'score-display goal-reached-text' : 'score-display';
            const container = document.getElementById('tally-container');
            container.innerHTML = '';
            let groups = Math.floor(currentPoints / 5);
            let rem = currentPoints % 5;
            for (let i = 0; i < groups; i++) container.innerHTML += '<span class="tally-group">Âçå</span>';
            if (rem > 0) container.innerHTML += `<span class="tally-group">${'|'.repeat(rem)}</span>`;
        }

        function renderLog(data) {
            const list = document.getElementById('log-list');
            list.innerHTML = '';
            const cutoff = Date.now() - (24 * 60 * 60 * 1000);
            const filtered = Object.values(data).filter(item => item.timestamp > cutoff).reverse();
            if (filtered.length === 0) {
                list.innerHTML = '<p style="color:#999; font-size:0.9rem; text-align:center;">No recent activity.</p>';
                return;
            }
            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = `log-item ${item.type === 'goal' ? 'log-goal' : ''}`;
                div.innerHTML = `<span class="log-time">${item.timeLabel}</span><span class="log-action ${item.type === 'add' ? 'text-add' : (item.type === 'sub' ? 'text-sub' : 'text-goal')}">${item.change}</span>`;
                list.appendChild(div);
            });
        }

        function securePasscodeSetup() {
            if (savedPasscode) {
                let oldPass = prompt("Enter the OLD passcode to change it:");
                if (oldPass !== savedPasscode) {
                    alert("Incorrect old passcode. Access denied.");
                    return;
                }
            }
            const first = prompt("Enter a NEW 4-digit passcode:");
            if (!first || first.length !== 4 || isNaN(first)) return alert("Passcode must be 4 digits.");
            const second = prompt("Confirm NEW passcode:");
            if (first === second) {
                db.ref('settings/passcode').set(first);
                alert("Passcode updated successfully!");
            } else alert("Passcodes do not match.");
        }

        function requestClearLog() {
            if (!savedPasscode) return alert("Set a passcode first.");
            let input = prompt("Enter passcode to clear log history:");
            while (input !== null && input !== savedPasscode) {
                input = prompt("Wrong passcode! Try again (or Cancel):");
            }
            if (input === savedPasscode) {
                db.ref('activity_log').remove();
                alert("Log cleared.");
            }
        }
    </script>
</body>
</html>
